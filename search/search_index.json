{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"AI-Driven Hybrid Cloud Infrastructure \u00b7 Documentation Hub","text":""},{"location":"#overview","title":"Overview","text":"<p>This documentation hub presents a structured, end-to-end blueprint for how a mid-sized organization can build and evolve a secure, AI-powered document management and retrieval system. The project begins with on-premises infrastructure and will gradually move some of the services to the cloud, and it will result in a hybrid architecture that balances cost, security, and scalability.</p> <p>The goal is to simulate a real-world IT transformation journey while showcasing modern practices in networking, automation, observability, and MLOps.</p>"},{"location":"#summary-at-a-glance","title":"Summary at a Glance","text":"Category Details Organization Type Mid-sized U.S. Government contractor Objective Build a hybrid AI-powered document search platform Starting Point On-premises infrastructure on a Dell R720 server Target Outcome Gradual migration of services to AWS Free Tier while maintaining hybrid Key Technologies Proxmox, Nextcloud, FastAPI, LangChain, Qdrant, MLflow, Prefect, Terraform, Grafana Compliance Focus DFARS, NIST 800-171 Documentation Goal Showcase real-world enterprise skills for career portfolio"},{"location":"#business-background","title":"Business Background","text":"Organization ABC Type Mid-sized U.S. Government contractor Focus Cybersecurity, communications, logistics Compliance DFARS, NIST 800-171 <p>Challenges: - Employees spend too much time searching for information buried in outdated shared drives. - The infrastructure is fragmented, with siloed systems and no centralized intelligence. - Due to compliance and budget constraints, not everything can move to the cloud.</p> <p>Solution: An internal AI-powered knowledge platform that makes documents easy to find, understand, and reuse\u2014without violating security requirements.</p>"},{"location":"#project-objectives","title":"Project Objectives","text":"Goal Description Document Search Modernization Use a local AI system to make files searchable Selective Cloud Migration Migrate cloud-suitable services using AWS Free Tier Monitoring and Automation Improve observability, logging, and task automation Hybrid Operations Maintain both on-prem and cloud infrastructure with security and access control"},{"location":"#project-structure","title":"Project Structure","text":"<p>This project is divided into seven major phases. Each phase includes focused tasks that build upon previous work.</p>"},{"location":"#phase-1-on-premise-infrastructure-setup","title":"Phase 1: On-Premise Infrastructure Setup","text":"Task Description Core Services Deploy Nextcloud, Qdrant, MLflow, FastAPI Virtualization Use Proxmox to host VMs Internal DNS Set up local name resolution and shared storage"},{"location":"#phase-2-network-design-and-security","title":"Phase 2: Network Design and Security","text":"Task Description Segmentation Isolate services using OPNsense VLANs Configure VLANs and static IPs Firewalling Enforce access policies and traffic control"},{"location":"#phase-3-cloud-foundations","title":"Phase 3: Cloud Foundations","text":"Task Description AWS Resources Set up VPC, IAM roles, and S3 buckets Infrastructure as Code Use Terraform for provisioning EC2 Setup Prepare virtual machines for later deployment"},{"location":"#phase-4-cloud-migrations","title":"Phase 4: Cloud Migrations","text":"Task Description Storage Migration Back up documents from Nextcloud to S3 API Offloading Deploy FastAPI layer to EC2 Monitoring Set up basic CloudWatch integration"},{"location":"#phase-5-ai-and-automation","title":"Phase 5: AI and Automation","text":"Task Description Document Pipeline Set up RAG architecture using LangChain and FastAPI Job Orchestration Use Prefect to automate ETL and retraining Result Storage Log outputs in Qdrant and MLflow"},{"location":"#phase-6-monitoring-and-observability","title":"Phase 6: Monitoring and Observability","text":"Task Description Logging Centralize data from hybrid systems Visualization Use Grafana dashboards Alerting Set up failure detection and performance alerts"},{"location":"#phase-7-reliability-and-failure-simulation","title":"Phase 7: Reliability and Failure Simulation","text":"Task Description Recovery Tests Simulate failures and validate failover plans Access Expiration Test IAM key expiry and alert systems Restore Scenarios Demonstrate backup and disaster recovery capabilities"},{"location":"#what-makes-this-project-unique","title":"What Makes This Project Unique","text":"Aspect Explanation Real-World Scope Mirrors actual migration and hybrid operations in mid-size companies Security Awareness Balances compliance and on-prem control with cloud advantages Technical Depth Combines Proxmox, OPNsense, AWS, MLflow, Terraform, and Grafana Full Lifecycle Coverage Goes from initial deployment to production hardening and chaos engineering <p>All design decisions, tradeoffs, and configurations are documented in the these sections.</p>"},{"location":"Guides/Documentation/mkdocs_offline_guide/","title":"MkDocs Offline Documentation Setup Guide","text":"<p>This guide walks you through a full offline-first setup of MkDocs with Material theme, including customization with CSS and project structure for technical documentation.</p>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#installation-steps-ubuntudebian","title":"\ud83d\ude80 Installation Steps (Ubuntu/Debian)","text":"<ol> <li>Install Python, pip, and virtualenv:</li> </ol> <pre><code>sudo apt update\nsudo apt install -y python3 python3-pip python3-venv git\n</code></pre> <ol> <li>Create project folder and virtual environment:</li> </ol> <pre><code>mkdir ~/my-docs\ncd ~/my-docs\npython3 -m venv .venv\nsource .venv/bin/activate\n</code></pre> <ol> <li>Install MkDocs and Material theme:</li> </ol> <pre><code>pip install mkdocs-material\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#recommended-project-structure","title":"\ud83d\udcc1 Recommended Project Structure","text":"<pre><code>my-docs/\n\u251c\u2500\u2500 .venv/                 # Virtual environment (not included in version control)\n\u251c\u2500\u2500 docs/                  # Markdown files (site content)\n\u2502   \u251c\u2500\u2500 index.md\n\u2502   \u251c\u2500\u2500 intro.md\n\u2502   \u251c\u2500\u2500 cloud.md\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 assets/               # Optional custom assets (CSS, images)\n\u2502   \u251c\u2500\u2500 css/\n\u2502   \u2502   \u2514\u2500\u2500 custom.css\n\u2502   \u2514\u2500\u2500 images/\n\u2502       \u2514\u2500\u2500 bg.jpg\n\u251c\u2500\u2500 mkdocs.yml            # Site configuration file\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#mkdocs-material-setup","title":"\u2699\ufe0f MkDocs + Material Setup","text":"<p>Edit <code>mkdocs.yml</code>:</p> <pre><code>site_name: My Offline Docs\n\ntheme:\n  name: material\n  palette:\n    scheme: slate\n  font:\n    text: Roboto Mono\n    code: JetBrains Mono\n\nextra_css:\n  - assets/css/custom.css\n\nnav:\n  - Home: index.md\n  - Introduction: intro.md\n  - Projects:\n      - Cloud: cloud.md\n      - AI: ai.md\n      - DevOps: devops.md\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#custom-theme-with-css-optional","title":"\ud83c\udfa8 Custom Theme with CSS (Optional)","text":"<p>Place this in <code>docs/assets/css/custom.css</code>:</p> <pre><code>/* Background for homepage */\nbody[data-md-page=\"index\"] .md-main__inner.md-grid {\n    background-image: url(\"../images/bg.jpg\");\n    background-size: cover;\n    background-position: center;\n    background-repeat: no-repeat;\n    min-height: 100vh;\n}\n\n/* Cool tech font + color scheme */\nbody {\n    font-family: 'Fira Code', monospace;\n    color: #40E0D0;\n}\n\n/* Transparent background boxes */\n.md-content, .md-sidebar, .md-header {\n    background-color: transparent !important;\n}\n\n.md-header {\n    background-color: #012a2a !important;\n}\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#preview-the-site-offline","title":"\ud83e\uddea Preview the Site Offline","text":"<p>Run locally with hot reload:</p> <pre><code>mkdocs serve\n</code></pre> <p>Visit: http://127.0.0.1:8000</p>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#build-static-site-for-offline-use","title":"\ud83c\udfd7 Build Static Site (for offline use)","text":"<pre><code>mkdocs build\n</code></pre> <p>This creates a static site in the <code>site/</code> directory. You can open <code>site/index.html</code> directly in any browser\u2014no server needed.</p> <p>To copy to another machine:</p> <pre><code>tar -czvf my-docs.tar.gz site/\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#optional-deploy-to-github-pages","title":"\u2601\ufe0f (Optional) Deploy to GitHub Pages","text":"<p>If you want to deploy later:</p> <ol> <li>Make sure the project is a git repo:</li> </ol> <pre><code>git init\ngit remote add origin &lt;your-github-url&gt;\n</code></pre> <ol> <li>Deploy with built-in command:</li> </ol> <pre><code>mkdocs gh-deploy\n</code></pre>"},{"location":"Guides/Documentation/mkdocs_offline_guide/#final-notes","title":"\u2705 Final Notes","text":"<ul> <li>You do not need to be online to preview, build, or browse the final output.</li> <li>Store and distribute the <code>site/</code> folder to share it.</li> <li>Use this guide for reproducible setups on air-gapped or legacy systems.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/","title":"Offline Network and Security Build with MikroTik CRS328 SwOS, OPNsense 25.7, UniFi AP, Raspberry Pi control plane, and NAS","text":""},{"location":"phases/1-onprem-bootstrap/#objective-and-build-order","title":"Objective and build order","text":"<p>We will build the network completely offline first, then cut over to the Internet in Phase 2. The sequence is designed to avoids lockouts and every change testable.</p> <ol> <li>Prepare the switch while it is at factory defaults.</li> <li>Put OPNsense behind the switch with a temporary LAN address that does not collide with the switch default.</li> <li>Plan and create VLANs on the switch with clear reasons for tagged and untagged choices.</li> <li>Create VLAN interfaces on OPNsense and move management to VLAN 10 safely.</li> <li>Bring the Raspberry Pi control plane online on VLAN 10 and run Pi-hole, Step CA, and FreeRADIUS in containers.</li> <li>Create the Storage VLAN 50 for the NAS on SFP+3.</li> <li>Configure DHCP and firewall policy per VLAN.</li> <li>Validate offline. No Internet is required to finish Phase 1.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#hardware-and-names","title":"Hardware and names","text":"<ol> <li>Firewall Protectli VP6670 running OPNsense 25.7</li> <li>Switch MikroTik CRS328-24P-4S+RM running SwOS layer 2 only</li> <li>Access Point UniFi Enterprise AP with PoE</li> <li>Server Dell PowerEdge R720 for Proxmox used in Phase 2</li> <li>Control plane Raspberry Pi 4B 8 GB with 256 GB SSD</li> <li>NAS on SFP+3 of the switch</li> <li>Admin laptop for configuration</li> <li>Local domain home.arpa</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#final-vlan-plan-and-addressing","title":"Final VLAN plan and addressing","text":"<p>This is the general (Highest level) summary. See Part 2. VLAN\u2011to\u2011OPNsense Interface Mapping for per\u2011interface details.</p> <p>This is the end state you will reach by the end of Phase 1.</p> Name VLAN IPv4 subnet Gateway DHCP Notes Management 10 10.10.10.0/24 10.10.10.1 Reservations switch, AP, iDRAC, ctlpln01, core infra Home 20 10.10.20.0/24 10.10.20.1 Yes trusted user devices Dev Apps 30 10.10.30.0/24 10.10.30.1 Yes lab apps and services Untrusted IoT 40 10.10.40.0/24 10.10.40.1 Yes TVs, cameras, IoT Storage 50 10.10.50.0/24 10.10.50.1 No NAS only Guest 60 10.10.60.0/24 10.10.60.1 Captive or PSK client isolation DMZ 70 10.10.70.0/24 10.10.70.1 No reverse proxy Phase 2 VPN 80 10.10.80.0/24 10.10.80.1 No future Quarantine 90 10.10.90.0/24 10.10.90.1 Yes parking VLAN Blackhole Native 999 none none none used only as native on trunks"},{"location":"phases/1-onprem-bootstrap/#reserved-addresses","title":"Reserved addresses","text":"IP Hostname Purpose 10.10.10.1 gw.home.arpa OPNsense Management interface on VLAN 10 10.10.10.2 sw01.home.arpa CRS328 SwOS management 10.10.10.5 idrac.home.arpa iDRAC 10.10.10.10 ox1.home.arpa Proxmox host management 10.10.10.20 mgmt01.home.arpa VM that hosts UniFi controller Phase 2 10.10.10.21 ap01.home.arpa UniFi AP 10.10.10.30 ctlpln01.home.arpa Raspberry Pi control plane 10.10.50.10 nas01.home.arpa NAS on Storage VLAN 50 10.10.70.10 proxy01.home.arpa Reverse proxy VM Phase 2"},{"location":"phases/1-onprem-bootstrap/#service-names","title":"Service names","text":"<ol> <li>step.home.arpa is a CNAME to ctlpln01.home.arpa</li> <li>radius.home.arpa is a CNAME to ctlpln01.home.arpa</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#port-to-vlan-quick-map","title":"Port to VLAN quick map","text":"<p>Use this table when you are plugging devices.</p> Switch ports Device or use Mode PVID VLANs carried or assigned SFP+1 VP6670 OPNsense Trunk 999 10,20,30,40,50,60,70,80,90,999 SFP+2 Dell R720 Proxmox Trunk 999 10,20,30,40,50,60,70,80,90,999 SFP+3 NAS Access 50 50 SFP+4 Spare Trunk 999 10,20,30,40,50,60,70,80,90,999 1\u20134 Cameras Access 40 40 5 Raspberry Pi Access 10 10 6 UniFi AP Access then Trunk 10 then 999 10 first. Later 10,20,40,60,999 7 iDRAC Access 10 10 8\u201312 Home clients Access 20 20 13\u201314 Dev wired Access 30 30 23 Quarantine jack Access 90 90 24 Admin laptop Access 10 10 <p>Important notes 1. VLAN Mode must be strict on every port. 2. Trunks use VLAN Receive only tagged and PVID 999. Never check Force VLAN ID on trunks. 3. Access ports use VLAN Receive only untagged and PVID set to that access VLAN. Check Force VLAN ID on access ports to drop any tagged frames sent by clients. 4. Do not include VLAN 999 in access port membership. Keep VLAN 999 only on trunks.</p>"},{"location":"phases/1-onprem-bootstrap/#stage-0-offline-bootstrap-approach","title":"Stage 0  Offline bootstrap approach","text":"<p>Why the temporary 192.168.88.0/24 network 1. SwOS ships at 192.168.88.1 with no VLANs. You need to reach it first. 2. Give OPNsense LAN a temporary IP of 192.168.88.2 so laptop and switch and firewall all talk before you create VLANs. 3. After VLAN 10 exists and works you will move management to 10.10.10.0/24 and remove the temporary network.</p> <p>What tagged and untagged mean in SwOS 1. Tagged frames carry a VLAN ID inside the Ethernet header. Trunks use tags to carry many VLANs over one link. 2. Untagged frames have no VLAN tag. Access ports use untagged frames for simple endpoints like laptops. 3. Default VLAN ID also called PVID on an access port assigns untagged ingress traffic to a VLAN. 4. Strict VLAN mode enforces membership so a port only accepts and sends VLANs you explicitly allow. 5. Native VLAN on a trunk is the VLAN used for untagged frames arriving on the trunk. You will not use a real VLAN here. You will use VLAN 999 as a blackhole so stray untagged frames do nothing.</p>"},{"location":"phases/1-onprem-bootstrap/#section-a-physical-cabling-for-the-offline-lab","title":"Section A \u2013 Physical cabling for the offline lab","text":"<ol> <li>Connect Protectli SFP+1 to CRS328 SFP+1. This is internal trunk later.</li> <li>Connect the admin laptop to copper port 24 on the CRS328.</li> <li>Keep the ONT and Internet disconnected. Leave the WAN port on the Protectli empty.</li> <li>Keep the UniFi AP unplugged for now. You will adopt it in Phase 2 after the controller exists.</li> <li>Keep the Raspberry Pi powered but leave Ethernet disconnected until VLAN 10 exists.</li> <li>Leave the NAS unplugged until VLAN 50 exists.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#section-b-reach-swos-at-its-factory-ip-and-harden-basics","title":"Section B \u2013 Reach SwOS at its factory IP and harden basics","text":"<p>Laptop temporary IP 1. On your laptop set a manual IPv4 of 192.168.88.10 with mask 255.255.255.0 and gateway empty.</p> <p>Log in and change core settings 1. Open http://192.168.88.1 in a browser. 2. Log in as admin with an empty password. Set a strong password immediately. 3. Click System. Set Identity to sw01.home.arpa. Change the IP Address to Static at 10.10.10.2. Enable Independent VLAN Learning. Save. 4. Change the jump01 management pc IP address to 10.10.10.3.</p>"},{"location":"phases/1-onprem-bootstrap/#section-c-give-opnsense-a-temporary-lan-ip-so-you-can-reach-its-gui","title":"Section C \u2013 Give OPNsense a temporary LAN IP so you can reach its GUI","text":"<p>Use the console on the Protectli 1. Connect a keyboard and HDMI or serial cable to the Protectli. 2. Boot OPNsense and wait for the text menu. 3. Choose Assign Interfaces if needed and make sure your internal NIC is LAN. 4. Choose Set interface IP address then select LAN. 5. Set IPv4 to 10.10.10.4/24. No upstream gateway on LAN. Skip IPv6 for now.</p> <p>Log in to the OPNsense GUI 1. On the laptop open https://10.10.10.4 and accept the certificate warning. 2. Run the setup wizard. Set a strong admin password and your timezone. 3. Do not change WAN. Leave it disconnected for now.</p>"},{"location":"phases/1-onprem-bootstrap/#section-d-plan-vlans-and-mark-ports-before-you-configure","title":"Section D \u2013 Plan VLANs and mark ports before you configure","text":"<p>Decide the roles now so you do not guess later. 1. SFP+1 to Protectli will become a trunk. Carries VLANs 10, 20, 30, 40, 50, 60, 70, 80, 90. Native PVID set to 999. 2. SFP+2 to Proxmox will be a trunk. Same membership and PVID 999. 3. SFP+3 to NAS will be access in VLAN 50. No tags. 4. SFP+4 spare trunk. Same as SFP+1. PVID 999. 5. Port 24 admin laptop will be access in VLAN 10 while you are building. 6. Port 5 Raspberry Pi will be access in VLAN 10. 7. Port 6 UniFi AP will be access in VLAN 10 for adoption. After adoption you will convert it to a trunk that carries VLANs 10, 20, 40 and 60. 8. Ports 1\u20134 cameras will be access in VLAN 40. 9. Ports 8\u201312 Home wired access in VLAN 20. 10. Ports 13\u201314 Dev wired access in VLAN 30. 11. Port 23 Quarantine access in VLAN 90.</p> <p>Why PVID 999 on trunks 1. If any untagged frame appears on a trunk it gets mapped into VLAN 999 which has no Layer 3 gateway or DHCP. That traffic dies safely.</p>"},{"location":"phases/1-onprem-bootstrap/#section-e-create-vlans-in-swos-and-apply-per-port-behavior","title":"Section E \u2013 Create VLANs in SwOS and apply per port behavior","text":"<p>VLANs tab 1. Add VLAN IDs 10, 20, 30, 40, 50, 60, 70, 80, 90, 999. Name them Mgmt, Home, Dev, IoT, Storage, Guest, DMZ, VPN, Quarantine, Blackhole. 2. Learning enabled for all real VLANs. 3. IGMP Snooping enabled for Home and IoT if you use casting. 4. Members for each VLAN. Tick the ports exactly as follows.    1. VLAN 10 Mgmt members SFP+1, SFP+2, SFP+4, ports 5, 6, 7, 24.    2. VLAN 20 Home members SFP+1, SFP+2, SFP+4, ports 8, 9, 10, 11, 12.    3. VLAN 30 Dev members SFP+1, SFP+2, SFP+4, ports 13, 14.    4. VLAN 40 IoT members SFP+1, SFP+2, SFP+4, ports 1, 2, 3, 4.    5. VLAN 50 Storage members SFP+1, SFP+2, SFP+3, SFP+4.    6. VLAN 60 Guest members SFP+1, SFP+2, SFP+4.    7. VLAN 70 DMZ members SFP+1, SFP+2, SFP+4.    8. VLAN 80 VPN members SFP+1, SFP+2, SFP+4.    9. VLAN 90 Quarantine members SFP+1, SFP+2, SFP+4, port 23.    10. VLAN 999 Blackhole members SFP+1, SFP+2, SFP+4. 5. Save and then go to the VLAN tab.</p> <p>VLAN tab per port Set VLAN Mode strict for every port. 1. SFP+1 to OPNsense. VLAN Receive only tagged. Default VLAN ID 999. Force VLAN ID unchecked. Save. 2. SFP+2 to Proxmox. VLAN Receive only tagged. Default VLAN ID 999. Force VLAN ID unchecked. Save. 3. SFP+3 to NAS. VLAN Receive only untagged. Default VLAN ID 50. Force VLAN ID checked. Save. 4. SFP+4 spare trunk. VLAN Receive only tagged. Default VLAN ID 999. Force VLAN ID unchecked. Save. 5. Ports 1\u20134 cameras. VLAN Receive only untagged. Default VLAN ID 40. Force VLAN ID checked. Save. 6. Port 5 Raspberry Pi. VLAN Receive only untagged. Default VLAN ID 10. Force VLAN ID checked. Save. 7. Port 6 UniFi AP during adoption. VLAN Receive only untagged. Default VLAN ID 10. Force VLAN ID checked. Save. 8. Port 7 iDRAC. VLAN Receive only untagged. Default VLAN ID 10. Force VLAN ID checked. Save. 9. Ports 8\u201312 Home. VLAN Receive only untagged. Default VLAN ID 20. Force VLAN ID checked. Save. 10. Ports 13\u201314 Dev. VLAN Receive only untagged. Default VLAN ID 30. Force VLAN ID checked. Save. 11. Port 23 Quarantine. VLAN Receive only untagged. Default VLAN ID 90. Force VLAN ID checked. Save. 12. Port 24 Admin laptop. VLAN Receive only untagged. Default VLAN ID 10. Force VLAN ID checked. Save.</p>"},{"location":"phases/1-onprem-bootstrap/#swos-opnsense-vlan10-cutover","title":"SwOS + OPNsense VLAN10 Cutover","text":"<p>Info</p> <p>Scope: CRS328\u201324P-4S+RM running SwOS and OPNsense 25.7.  </p> <p>Tip</p> <p>Goal: Management on VLAN10 only. Switch at 10.10.10.2. OPNsense at 10.10.10.1.  </p> <p>Warning</p> <p>Important: Do not change Port Isolation from its current default on the switch. Leave it as is.</p>"},{"location":"phases/1-onprem-bootstrap/#step-1-basic-access-confirm-current-state","title":"Step 1. Basic Access (confirm current state)","text":"<ol> <li>Connect your laptop to a copper port on the switch.</li> <li>Ensure you can open the SwOS GUI at <code>http://10.10.10.2</code>.</li> <li>Ensure OPNsense has the VLAN10 interface enabled with <code>10.10.10.1/24</code>:</li> <li>OPNsense: Interfaces \u2192 Assignments \u2192 select VLAN10 \u2192 Enable checked \u2192 IPv4 Static <code>10.10.10.1/24</code> \u2192 Save \u2192 Apply.</li> <li>OPNsense DHCP for VLAN10:</li> <li>Services \u2192 DHCPv4 \u2192 VLAN10 \u2192 Enable \u2192 Range <code>10.10.10.200\u201310.10.10.210</code> \u2192 Save.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#step-2-create-vlans-swos-vlans-tab","title":"Step 2. Create VLANs (SwOS \u2192 VLANs tab)","text":"<p>Add the following VLAN IDs:</p> <ul> <li>10 Management  </li> <li>20 Home  </li> <li>30 Dev  </li> <li>40 IoT  </li> <li>50 Storage  </li> <li>60 Guest  </li> <li>70 DMZ  </li> <li>80 VPN  </li> <li>90 Quarantine  </li> <li>999 Blackhole</li> </ul> <p>Keep \u201cLearning\u201d enabled. If using services i.e. Chromecast or AirPlay, enable IGMP Snooping for VLAN 20 and 40.</p>"},{"location":"phases/1-onprem-bootstrap/#step-3-vlan-memberships-swos-vlans-tab","title":"Step 3. VLAN Memberships (SwOS \u2192 VLANs tab)","text":"<p>Tick ports as members exactly:</p> <ul> <li>VLAN 10: SFP+1, SFP+2, SFP+4, ports 5, 6, 7, 24  </li> <li>VLAN 20: SFP+1, SFP+2, SFP+4, ports 8\u201312  </li> <li>VLAN 30: SFP+1, SFP+2, SFP+4, ports 13\u201314  </li> <li>VLAN 40: SFP+1, SFP+2, SFP+4, ports 1\u20134  </li> <li>VLAN 50: SFP+1, SFP+2, SFP+3, SFP+4  </li> <li>VLAN 60: SFP+1, SFP+2, SFP+4  </li> <li>VLAN 70: SFP+1, SFP+2, SFP+4  </li> <li>VLAN 80: SFP+1, SFP+2, SFP+4  </li> <li>VLAN 90: SFP+1, SFP+2, SFP+4, port 23  </li> <li>VLAN 999: SFP+1, SFP+2, SFP+4</li> </ul> <p>Click Save.</p> <p>Note</p> <p>Port Isolation: Do not change the Port Isolation defaults in this tab or in the Port Isolation tab. Leave them as is, per your working setup. Do not change the Port Isolation defaults in this tab or in the Port Isolation tab. Leave them as is, per your working setup.</p>"},{"location":"phases/1-onprem-bootstrap/#step-4-per-port-behavior-swos-vlan-tab","title":"Step 4. Per-Port Behavior (SwOS \u2192 VLAN tab)","text":"<p>Configure each port:</p>"},{"location":"phases/1-onprem-bootstrap/#trunks","title":"Trunks","text":"<ul> <li>SFP+1 (to OPNsense) </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only tagged </li> <li>Default VLAN ID (PVID) = 999 </li> <li> <p>Force VLAN ID = unchecked</p> </li> <li> <p>SFP+2 (to Proxmox) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only tagged </li> <li>Default VLAN ID (PVID) = 999 </li> <li> <p>Force VLAN ID = unchecked</p> </li> <li> <p>SFP+4 (spare trunk) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only tagged </li> <li>Default VLAN ID (PVID) = 999 </li> <li>Force VLAN ID = unchecked</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#access","title":"Access","text":"<ul> <li>SFP+3 (NAS) </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 50 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Ports 1\u20134 (PoE Security Cameras) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 40 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Port 5 (Raspberry Pi) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 10 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Port 6 (UniFi AP) </p> </li> <li>Start as access for adoption: strict, only untagged, PVID = 10, Force checked.  </li> <li> <p>Later in Phase 2 convert to trunk carrying 10, 20, 40, 60, 999.</p> </li> <li> <p>Port 7 (iDRAC) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 10 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Ports 8\u201312 (Home) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 20 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Ports 13\u201314 (Dev wired) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 30 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Port 23 (Quarantine) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 90 </li> <li> <p>Force VLAN ID = checked</p> </li> <li> <p>Port 24 (Admin laptop) </p> </li> <li>VLAN Mode = strict </li> <li>VLAN Receive = only untagged </li> <li>Default VLAN ID (PVID) = 10 </li> <li>Force VLAN ID = checked</li> </ul> <p>Click Save.</p>"},{"location":"phases/1-onprem-bootstrap/#step-5-other-tabs","title":"Step 5. Other Tabs","text":"<ul> <li>Link: verify SFP+ ports link at 10G; copper at 1G.  </li> <li>PoE: enable PoE Out Auto on ports 1\u20134 (cameras) and 6 (AP). Others Off.  </li> <li>RSTP: enable RSTP. Mark access ports (1\u20134, 5, 6, 7, 8\u201314, 23, 24) as Edge = Yes. Leave trunks (SFP+1, SFP+2, SFP+4) Edge = No.  </li> <li>Forwarding: set broadcast and multicast storm control to 1% on access ports.  </li> <li>IGMP: enable global IGMP Snooping. Do not enable Querier yet.  </li> <li>SNMP: disable unless monitoring. If enabled, restrict to <code>10.10.10.0/24</code> with a strong community.  </li> <li>System: keep switch IP at <code>10.10.10.2/24</code>. Restrict management to VLAN10 and <code>10.10.10.0/24</code> only.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#step-6-opnsense-retire-the-old-lan-ip-this-was-your-final-fix","title":"Step 6. OPNsense \u2014 retire the old LAN IP (this was your final fix)","text":"<ol> <li>OPNsense \u2192 Interfaces \u2192 LAN \u2192 set IPv4 Configuration Type = None \u2192 Save \u2192 Apply.  </li> <li>This removes <code>10.10.10.4</code> and eliminates the same-subnet overlap that caused conflicts.  </li> <li>From your admin laptop on Port 24 (PVID 10):  </li> <li>Set NIC to DHCP. Confirm lease <code>10.10.10.200\u201310.10.10.210</code>, gateway <code>10.10.10.1</code>.  </li> <li>Open <code>https://10.10.10.1</code> (OPNsense GUI).  </li> <li>Open <code>http://10.10.10.2</code> (SwOS GUI).</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#step-7-validate-and-backup","title":"Step 7. Validate and Backup","text":"<ul> <li>Confirm you can consistently reach:</li> <li>OPNsense at <code>https://10.10.10.1</code> from Port 24.  </li> <li>SwOS at <code>http://10.10.10.2</code> from Port 24.  </li> <li>SwOS \u2192 System \u2192 Backup \u2192 download config.  </li> <li>OPNsense \u2192 System \u2192 Configuration \u2192 Backups \u2192 download config.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#notes","title":"Notes","text":"<ul> <li>Leaving Port Isolation at current default was necessary in this environment, since they're isolated anyway. Do not change it now that everything is stable.  </li> <li>Retiring the LAN IPv4 was essential because having <code>10.10.10.4</code> (LAN) and <code>10.10.10.1</code> (VLAN10) in the same/24 causes ARP and routing ambiguity. Removing LAN\u2019s IP resolved this.  </li> <li>VLAN999 is your native \u201cblackhole\u201d VLAN for trunks; it is not the trunk itself. We set PVID 999 on trunks to safely dispose of stray untagged frames.  </li> <li>Convert the AP port to a trunk later (Phase 2) after the controller is up and SSIDs are mapped to their VLANs.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#opnsense-bootstrap-vlan-mapping-8021q-and-security-audit","title":"OPNsense Bootstrap, VLAN Mapping, 802.1Q, and Security Audit","text":"<p>Target hardware: Protectli VP6670 (OPNsense 25.7) + MikroTik CRS328\u201324P-4S+RM (L2)  </p> <p>Tip</p> <p>Goal: Clean, least\u2011privilege segmentation with standards\u2011based 802.1Q tagging and defense\u2011in\u2011depth.</p>"},{"location":"phases/1-onprem-bootstrap/#part-1-initial-opnsense-bootstrap","title":"Part 1. Initial OPNsense Bootstrap","text":"<p>When first booting the Protectli (OPNsense 25.7):</p>"},{"location":"phases/1-onprem-bootstrap/#a-assign-temporary-lan-ip","title":"A. Assign temporary LAN IP","text":"<ol> <li>On the OPNsense console menu, select Option 2 \u2014 Assign Interfaces.  </li> <li>Choose LAN = <code>ixl0</code> (the 10 GbE interface cabled to CRS328 SFP+1).  </li> <li>Set temporary static IPv4 to <code>10.10.10.4/24</code>.  </li> <li>This gives GUI access via the switch (which will be at <code>10.10.10.2</code>).</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#b-access-the-gui","title":"B. Access the GUI","text":"<ol> <li>On jump01 (plugged into switch port 24), set static IP <code>10.10.10.3/24</code>.  </li> <li>Browse to <code>https://10.10.10.4</code> and log in.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#c-create-vlan10-management","title":"C. Create VLAN10 (Management)","text":"<ol> <li>Navigate Interfaces \u2192 Devices \u2192 VLAN \u2192 Add.  </li> <li>Parent interface: <code>ixl0</code> </li> <li>VLAN Tag: <code>10</code> </li> <li>Description: <code>Management</code> </li> <li>Save and Apply.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#d-assign-the-new-interface","title":"D. Assign the new interface","text":"<ol> <li>Interfaces \u2192 Assignments \u2192 + to add the newly created VLAN device.  </li> <li>Enable the interface; set static IPv4 = <code>10.10.10.1/24</code>.  </li> <li>Apply.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#e-migrate-management-to-vlan10","title":"E. Migrate management to VLAN10","text":"<ol> <li>Test access to <code>https://10.10.10.1</code> from jump01.  </li> <li>Once confirmed, go to Interfaces \u2192 LAN and set IPv4 = None.  </li> <li>This retires <code>10.10.10.4</code> and leaves management on <code>10.10.10.1</code> only.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#part-2-vlantoopnsense-interface-mapping","title":"Part 2. VLAN\u2011to\u2011OPNsense Interface Mapping","text":"<p>This section provides detailed, per\u2011VLAN interface assignments. It complements and intentionally overlaps with the previous general table.</p> VLAN ID Name OPNsense Interface Subnet DHCP Pool Purpose / Devices Notes 10 Management VLAN10 (<code>ixl0.10</code>) 10.10.10.1/24 10.10.10.200\u2013210 Switch mgmt (10.10.10.2), OPNsense GUI, Pi, UniFi Controller VM, iDRAC Primary mgmt only. Allow HTTPS/DNS/SSH to mgmt tools. Block Internet except updates. 20 Home VLAN20 (<code>ixl0.20</code>) 10.10.20.1/24 10.10.20.100\u2013150 Personal devices: PCs, TVs, printers Internet allowed. No access to Mgmt/Servers except DNS. 30 Dev VLAN30 (<code>ixl0.30</code>) 10.10.30.1/24 10.10.30.100\u2013150 Dev VMs, coding boxes, lab tools Internet allowed. May reach Servers when explicitly permitted. 40 IoT VLAN40 (<code>ixl0.40</code>) 10.10.40.1/24 10.10.40.100\u2013200 Security cams (ports 1\u20134), smart plugs Internet allowed (apps). No lateral or Mgmt access. 50 Storage VLAN50 (<code>ixl0.50</code>) 10.10.50.1/24 10.10.50.100\u2013120 NAS (SFP+3), backup appliances Internet only for updates. Accessible from Dev/Servers as needed. 60 Guest VLAN60 (<code>ixl0.60</code>) 10.10.60.1/24 10.10.60.50\u2013150 Visitors\u2019 phones, laptops Internet\u2011only. Block LAN/Mgmt/Servers. 70 DMZ VLAN70 (<code>ixl0.70</code>) 10.10.70.1/24 Static/manual Reverse proxy, public\u2011facing services Controlled Internet + inbound NAT. No LAN access. 80 VPN VLAN80 (<code>ixl0.80</code>) 10.10.80.1/24 10.10.80.100\u2013150 VPN tunnel endpoints, jump box Internet allowed. Policy routes to internal nets via VPN policies. 90 Quarantine VLAN90 (<code>ixl0.90</code>) 10.10.90.1/24 10.10.90.100\u2013120 Suspicious/infected machines Internet only (DNS + updates). No local access. 999 Blackhole \u2014 \u2014 \u2014 Catch\u2011all for untagged/unused ports Exists only on the switch, not in OPNsense."},{"location":"phases/1-onprem-bootstrap/#part-3-defenseindepth-firewall-rules-pervlan","title":"Part 3. Defense\u2011in\u2011Depth Firewall Rules (per\u2011VLAN)","text":"<p>Create these under Firewall \u2192 Rules \u2192 [interface] in OPNsense. Log denies where noted.</p>"},{"location":"phases/1-onprem-bootstrap/#vlan10-management","title":"VLAN10 (Management)","text":"<ul> <li><code>Allow</code> <code>VLAN10 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN10 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN10 net \u2192 This Firewall</code> TCP 443 (GUI).  </li> <li><code>Allow</code> <code>VLAN10 net \u2192 This Firewall</code> TCP 22 (SSH, if enabled).  </li> <li><code>Allow</code> <code>VLAN10 net \u2192 *</code> DNS, NTP, ICMP.  </li> <li><code>Allow</code> <code>VLAN10 net \u2192 Internet</code> (firmware/OS updates only; optionally use an alias).  </li> <li><code>Block</code> <code>VLAN10 net \u2192</code> all other internal VLANs (except DNS resolver if off\u2011box).  </li> <li>Log all denies.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan20-home","title":"VLAN20 (Home)","text":"<ul> <li><code>Allow</code> <code>VLAN20 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN20 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN20 net \u2192 Internet (any)</code> </li> <li><code>Allow</code> <code>VLAN20 net \u2192 VLAN20 net</code> (intra\u2011LAN as needed)  </li> <li><code>Block</code> <code>VLAN20 net \u2192 VLAN10 (Mgmt)</code> </li> <li><code>Block</code> <code>VLAN20 net \u2192 VLAN30, VLAN40, VLAN50</code> (permit specific NAS/printer access if desired)  </li> <li>DNS via Pi\u2011hole or OPNsense.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan30-dev","title":"VLAN30 (Dev)","text":"<ul> <li><code>Allow</code> <code>VLAN30 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN30 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN30 net \u2192 Internet</code> </li> <li><code>Allow</code> <code>VLAN30 net \u2192 VLAN50 (Storage)</code> </li> <li><code>Block</code> <code>VLAN30 net \u2192 VLAN10 (Mgmt)</code> </li> <li><code>Block</code> <code>VLAN30 net \u2192 VLAN20 (Home)</code> </li> <li>Optional: allow SSH/RDP into Servers/DMZ for testing (tight scope + auth).</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan40-iot-cameras","title":"VLAN40 (IoT / Cameras)","text":"<ul> <li><code>Allow</code> <code>VLAN40 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN40 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN40 net \u2192 Internet</code> (app/cloud)  </li> <li><code>Allow</code> <code>VLAN40 net \u2192 VLAN50</code> (NVR/NAS target only)  </li> <li><code>Block</code> <code>VLAN40 net \u2192 VLAN10, VLAN20, VLAN30</code> </li> <li><code>Block</code> <code>VLAN40 net \u2192 VLAN40 net</code> (isolate IoT devices from each other, if desired)  </li> <li>Only DNS, NTP, HTTPS outbound otherwise.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan50-storage","title":"VLAN50 (Storage)","text":"<ul> <li><code>Allow</code> <code>VLAN50 net \u2192 Internet</code> (updates)  </li> <li><code>Allow</code> from <code>VLAN30 (Dev)</code> (file access)  </li> <li><code>Allow</code> from <code>VLAN20 (Home)</code> if media access desired  </li> <li><code>Block</code> <code>VLAN50 net \u2192 VLAN10 (Mgmt)</code> </li> <li><code>Block</code> <code>VLAN50 net \u2192 VLAN40 (IoT)</code> </li> <li>Default block all else.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan60-guest","title":"VLAN60 (Guest)","text":"<ul> <li><code>Allow</code> <code>VLAN60 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN60 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN60 net \u2192 Internet</code> </li> <li><code>Block</code> <code>VLAN60 net \u2192</code> all RFC1918 (10/8, 172.16/12, 192.168/16)  </li> <li><code>Block</code> <code>VLAN60 net \u2192 VLAN10,20,30,40,50,70,80,90</code> </li> <li><code>Allow</code> DNS only to OPNsense/Pi\u2011hole.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan70-dmz","title":"VLAN70 (DMZ)","text":"<ul> <li><code>Allow</code> <code>VLAN70 net \u2192 Internet</code> </li> <li><code>Allow</code> inbound NAT: <code>Internet \u2192 VLAN70</code> specific services only (e.g., 443 to reverse proxy)  </li> <li><code>Block</code> <code>VLAN70 net \u2192 LANs (Mgmt, Home, Dev, IoT, etc.)</code> </li> <li><code>Allow</code> <code>VLAN70 net \u2192 VLAN50</code> only if reverse proxy must fetch content from NAS  </li> <li>Log all denies.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan80-vpn","title":"VLAN80 (VPN)","text":"<ul> <li><code>Allow</code> <code>VPN clients \u2192 VLAN10 (Mgmt)</code> only if remote admin required (strong auth + MFA).  </li> <li><code>Allow</code> <code>VPN clients \u2192 VLAN20, VLAN30, VLAN50</code> per access policy.  </li> <li><code>Block</code> <code>VPN clients \u2192 VLAN40 (IoT), VLAN60 (Guest)</code> </li> <li><code>Allow</code> <code>VPN clients \u2192 Internet</code> </li> <li>Enforce MFA on VPN service.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan90-quarantine","title":"VLAN90 (Quarantine)","text":"<ul> <li><code>Allow</code> <code>VLAN90 net \u2192 10.10.10.30</code> TCP/UDP 53 (DNS) (Pi-hole).</li> <li><code>Block</code> <code>VLAN90 net \u2192 any</code> TCP/UDP 53 (block external DNS; keep above the Internet-allow rule).</li> <li><code>Allow</code> <code>VLAN90 net \u2192 Internet</code> only DNS, HTTP/HTTPS, Windows Update </li> <li><code>Block</code> <code>VLAN90 net \u2192 all other VLANs</code> </li> <li>Log all denies.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#vlan999-blackhole","title":"VLAN999 (Blackhole)","text":"<ul> <li>No interface in OPNsense. Not routed. Switch drops or sinks unintended traffic.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#part-4-dhcp-best-practices","title":"Part 4. DHCP Best Practices","text":"<ul> <li>Use ISC DHCPv4 in OPNsense.  </li> <li>Enable DHCP only on dynamic\u2011client VLANs: 20, 30, 40, 60, 80, 90.  </li> <li>Static reservations for infrastructure: switch, NAS, APs, Pi, controller VMs, iDRAC.  </li> <li>On Mgmt (VLAN10), disable DHCP except a small jump01 pool (200\u2013210) if you want plug\u2011and\u2011play access on a jump port.  </li> <li>Use short leases on Guest and Quarantine (e.g., 2\u20138 hours).</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#part-5-defenseindepth-extras","title":"Part 5. Defense\u2011in\u2011Depth Extras","text":"<ul> <li>Block Bogon Networks on all internal VLANs (Interfaces \u2192 [VLAN] \u2192 Block bogons).  </li> <li>Block Private Networks on WAN.  </li> <li>DNS Resolver (or Forwarder) with DNSSEC enabled.  </li> <li>Syslog OPNsense and switch logs to your NAS/Pi (remote syslog).  </li> <li>Auto\u2011backup OPNsense config (System \u2192 Configuration \u2192 Backups).  </li> <li>Enable port\u2011security / storm control and isolation on switch access ports (already planned).  </li> <li>Use NTP from OPNsense or a trusted upstream; pin NTP in rules.  </li> <li>Maintain allow\u2011list for firmware/update domains (aliases) to minimize broad egress.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#part-6-8021q-vlan-tagging-switch-firewall","title":"Part 6. 802.1Q VLAN Tagging \u2014 Switch &amp; Firewall","text":""},{"location":"phases/1-onprem-bootstrap/#why-8021q-here","title":"Why 802.1Q here?","text":"<ul> <li>802.1Q is the standard for single\u2011tag VLAN trunking between your switch (CRS328) and OPNsense.  </li> <li>Do not use 802.1ad (QinQ) unless you intentionally need double\u2011tag encapsulation (you don\u2019t in this design).  </li> <li>Avoid \u201cAuto\u201d mode ambiguity; explicitly choose 802.1Q where the UI offers a choice.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#opnsense-ixl0-trunk","title":"OPNsense (ixl0 trunk)","text":"<ul> <li>The physical <code>ixl0</code> acts as a trunk carrying tags 10,20,30,40,50,60,70,80,90.  </li> <li>Each VLAN interface in OPNsense is created as <code>ixl0.&lt;tag&gt;</code> (e.g., <code>ixl0.10</code>).  </li> <li>No untagged/native VLAN on the OPNsense side of the trunk.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#mikrotik-crs328-swos-guidance","title":"MikroTik CRS328 (SwOS guidance)","text":"<ol> <li>VLANs table: Create entries for 10,20,30,40,50,60,70,80,90,999.  </li> <li>Ports \u2192 VLAN Mode: Set Trunk on the uplink to OPNsense (SFP+1).  </li> <li>Ports \u2192 Allowed VLANs: On the trunk, allow 10,20,30,40,50,60,70,80,90 (exclude 999 from the trunk so blackhole stays local to the switch).  </li> <li>Access ports: </li> <li>Assign per\u2011VLAN PVID (e.g., camera ports PVID=40, NAS port PVID=50, jump01 port PVID=10).  </li> <li>VLAN Mode: Access (egress untagged, ingress tagged \u2192 PVID).  </li> <li>Native VLAN: Prefer no native on trunks (tag everything). If the UI forces one, set an unused value and block it on OPNsense.  </li> <li>Blackhole VLAN 999: </li> <li>Create VLAN 999 only on the switch.  </li> <li>Set unused ports PVID=999 and isolate them. No uplink allowed. This safely sinks stray/untagged traffic.</li> </ol> <p>If you see \u201cVLAN number must be unique\u201d when adding VLANs: ensure each VLAN ID appears only once in the VLAN table and then applied to multiple ports via Allowed/Member lists instead of creating duplicate entries for the same ID.</p> <p>If presented with <code>Auto</code>, <code>802.1Q</code>, <code>802.1ad</code> in the VLAN type dropdown: choose 802.1Q for all VLANs and trunks in this design.</p>"},{"location":"phases/1-onprem-bootstrap/#part-7-security-configs-audit-hardening-actions","title":"Part 7. Security Configs Audit &amp; Hardening Actions","text":""},{"location":"phases/1-onprem-bootstrap/#summary","title":"Summary","text":"<ul> <li>Segmentation: Sound. Traffic constrained by per\u2011VLAN rules and explicit inter\u2011VLAN allowances.  </li> <li>Choke points: Single OPNsense trunk is clear and auditable.  </li> <li>Residual risk: Mis\u2011tagged/native VLANs, overly broad egress, weak VPN auth, IoT lateral movement, logging gaps.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#important-fixes-that-is-better-to-apply-them-now","title":"Important fixes that is better to apply them now","text":"<ol> <li>Tag everything on trunks; avoid native/untagged VLANs. Confirm switch trunk to OPNsense has only tagged 10\u201390.  </li> <li>Lock down egress with aliases per VLAN (e.g., restrict Mgmt/Storage to update domains).  </li> <li>VPN MFA enforced; restrict VPN to named user groups with per\u2011group firewall rules.  </li> <li>IoT isolation: Keep VLAN40 \u2192 VLAN40 blocked; allow only required outbound (DNS/NTP/HTTPS) and specific NVR targets.  </li> <li>DMZ inbound NAT minimization: Only required ports; terminate TLS on reverse proxy with strong ciphers, forward internally over mTLS where possible.  </li> <li>Admin plane hygiene: </li> <li>OPNsense GUI TLS only, no WAN exposure; restrict GUI/SSH to VLAN10 and VPN admin IPs.  </li> <li>Key\u2011based SSH, disable password auth.  </li> <li>Per\u2011admin accounts; no shared credentials.  </li> <li>Logging &amp; alerting: </li> <li>Remote syslog for OPNsense + switch.  </li> <li>Enable intrusion detection (Suricata) in IPS or IDS mode on selected VLANs (monitor first, then enforce).  </li> <li>DHCP discipline: No DHCP on Mgmt (except tiny jump pool). Short leases on Guest/Quarantine. Static reservations for infrastructure.  </li> <li>Time sync: Lock NTP to OPNsense; block outbound NTP except from OPNsense and designated servers.  </li> <li>Firmware &amp; backups: Auto\u2011backup OPNsense; keep Protectli BIOS/firmware current; snapshot configuration before major changes.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#will-wrap-up-with-these-hardenings-as-well","title":"Will wrap up with these hardenings as well","text":"<ul> <li>DNS over TLS or DoH on resolver/forwarder; pin upstreams via aliases.  </li> <li>802.1X/EAP\u2011TLS on wired switch ports where feasible (Mgmt/Servers) with a RADIUS VM.  </li> <li>mTLS inside the LAN for critical services (proxy \u2194 backend).  </li> <li>Threat\u2011intel blocklists (pfBlockerNG or native aliases) with careful testing.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#ipv4-only-lockdown-checklist-will-be-implementing-ipv6-dual-stack-of-ula-and-gua-later","title":"IPv4-Only Lockdown Checklist (Will be implementing IPv6 dual stack of ULA and GUA Later)","text":"<p>Tip</p> <p>Goal: ensure all VLANs and WAN run IPv4 only, no IPv6 addresses are advertised or routed. Prevents clients from bypassing IPv4 firewall rules via auto-IPv6.</p>"},{"location":"phases/1-onprem-bootstrap/#1-disable-ipv6-on-all-interfaces","title":"1. Disable IPv6 on all interfaces","text":"<ol> <li>In OPNsense GUI \u2192 Interfaces \u2192 [each interface] </li> <li>Set IPv6 Configuration Type = None.  </li> <li>Apply on: WAN, VLAN10\u201390, and any spares.  </li> <li>Click Save \u2192 Apply Changes.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#2-disable-router-advertisements","title":"2. Disable Router Advertisements","text":"<ol> <li>Services \u2192 Router Advertisements </li> <li>For every interface listed, set Router Advertisements = Disabled.  </li> <li>Save.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#3-disable-dhcpv6","title":"3. Disable DHCPv6","text":"<ol> <li>Services \u2192 DHCPv6 \u2192 [each interface] </li> <li>Ensure Enable DHCPv6 Server is unchecked.  </li> <li>Save.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#4-firewall-block-all-ipv6-rules","title":"4. Firewall \u201cBlock all IPv6\u201d rules","text":"<p>For belt-and-suspenders protection:</p> <ol> <li>Firewall \u2192 Rules \u2192 [each VLAN interface] \u2192 IPv6 tab </li> <li>Add rule:  <ul> <li>Action: Block  </li> <li>Interface: VLANxx  </li> <li>Protocol: IPv6 (any)  </li> <li>Source: any  </li> <li>Destination: any  </li> <li>Enable Log (optional).  </li> </ul> </li> <li>Move to top of ruleset.  </li> <li> <p>Save &amp; Apply.</p> </li> <li> <p>Repeat for WAN (IPv6 tab).</p> </li> </ol>"},{"location":"phases/1-onprem-bootstrap/#5-dns-unbound","title":"5. DNS / Unbound","text":"<ol> <li>Services \u2192 Unbound DNS \u2192 General </li> <li>Under Network Interfaces, deselect All if checked.  </li> <li>Explicitly include only IPv4 interfaces (VLANs + loopback).  </li> <li>Save &amp; Apply.</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#6-pi-hole-if-used","title":"6. Pi-hole (if used)","text":"<ol> <li>Settings \u2192 DNS </li> <li>Disable IPv6 listening.  </li> <li>Or, bind only to IPv4 addresses (10.10.x.x).  </li> <li>UFW: ensure no IPv6 rules are present (<code>sudo ufw status</code> \u2192 should say \u201cinactive (v6)\u201d).</li> </ol>"},{"location":"phases/1-onprem-bootstrap/#7-verification","title":"7. Verification","text":"<p>On a test client (Windows/macOS/Linux): - Run <code>ipconfig</code> / <code>ip -6 addr</code> \u2192 should only see link-local IPv6 (fe80::), no global (<code>2000::/3</code>) or ULA (<code>fdxx::/8</code>). - Run <code>ping -6 ipv6.google.com</code> \u2192 should fail. - Run <code>tracert -6 ipv6.google.com</code> / <code>traceroute -6</code> \u2192 should fail.</p> <p>With these steps in place: - No IPv6 config exists in OPNsense. - No RA/DHCPv6 runs, so clients can\u2019t get routable IPv6 addresses. - Firewall explicitly drops stray IPv6. - DNS only listens/responds on IPv4.  </p>"},{"location":"phases/1-onprem-bootstrap/#you-can-safely-leave-ipv6-untouched-until-youre-ready-in-phase-7","title":"You can safely leave IPv6 untouched until you\u2019re ready in Phase 7.","text":""},{"location":"phases/1-onprem-bootstrap/#outcome","title":"Outcome","text":"<p>With this structure:</p> <ul> <li>Every VLAN is represented in OPNsense with a distinct interface and subnet.  </li> <li>Each VLAN has a minimal DHCP scope and narrow firewall rules.  </li> <li>802.1Q tagging is explicit and consistent; there is no native VLAN on trunks.  </li> <li>Defense\u2011in\u2011depth = segmentation + least privilege + strong auth + logging.</li> </ul>"},{"location":"phases/1-onprem-bootstrap/#section-x-bring-up-the-raspberry-pi-control-plane-on-vlan-10","title":"Section X \u2013 Bring up the Raspberry Pi control plane on VLAN 10","text":"<ol> <li>Plug the Pi Ethernet into port 5 which is access VLAN 10.</li> <li>Give the Pi static IPv4 10.10.10.30/24 with gateway 10.10.10.1.</li> <li>If using optional local IPv6 give the Pi fd10:10:10:10::30/64.</li> <li>Verify Pi-hole admin at http://10.10.10.30/admin opens from a VLAN 10 host.</li> <li>Keep Conditional Forwarding disabled in Pi-hole.</li> </ol> <p>Secure the firewall on ctlpln01 with UFW 1. Ensure UFW default deny incoming and default allow outgoing. 2. Allow SSH only from 10.10.10.0/24 to port 22 TCP. 3. Allow Pi-hole admin only from 10.10.10.0/24 to port 80 TCP. 4. Allow Step CA only from 10.10.10.0/24 to port 443 TCP. 5. Allow RADIUS from 10.10.10.21 and 10.10.10.1 to ports 1812 and 1813 UDP. 6. Allow DNS from client VLANs to port 53 TCP and UDP with the following commands. <pre><code>sudo ufw allow from 10.10.20.0/24 to any port 53 proto tcp\nsudo ufw allow from 10.10.20.0/24 to any port 53 proto udp\nsudo ufw allow from 10.10.30.0/24 to any port 53 proto tcp\nsudo ufw allow from 10.10.30.0/24 to any port 53 proto udp\nsudo ufw allow from 10.10.40.0/24 to any port 53 proto tcp\nsudo ufw allow from 10.10.40.0/24 to any port 53 proto udp\nsudo ufw allow from 10.10.60.0/24 to any port 53 proto tcp\nsudo ufw allow from 10.10.60.0/24 to any port 53 proto udp\nsudo ufw allow from 10.10.90.0/24 to any port 53 proto tcp\nsudo ufw allow from 10.10.90.0/24 to any port 53 proto udp\n</code></pre></p> <ol> <li> <p>If you add new client VLANs later, repeat matching ufw allow \u2026 port 53 TCP and UDP rules for each new subnet.</p> </li> <li> <p>Enable UFW and verify status.</p> </li> </ol> <p>Point DHCP to Pi-hole and block DNS bypass 1. Services \u2192 DHCPv4 then each client VLAN. Set DNS servers to 10.10.10.30. Save. 2. System \u2192 Settings then General. Set firewall DNS to 10.10.10.30. Confirm WAN override is unchecked. 3. Firewall \u2192 Rules then each client VLAN. Create rules in this order.    1. Pass to 10.10.10.30 TCP 53.    2. Pass to 10.10.10.30 UDP 53.    3. Block to This Firewall TCP 53 with Log.    4. Block to This Firewall UDP 53 with Log.    5. Leave default block below or add a general allow for intra VLAN testing as needed.</p> <p>Unbound binding on OPNsense 1. Services \u2192 Unbound DNS then General. 2. Network Interfaces set only Localhost and VLAN10. 3. Save and Apply.</p>"},{"location":"phases/1-onprem-bootstrap/#section-y-storage-vlan-50-for-nas","title":"Section Y \u2013 Storage VLAN 50 for NAS","text":"<p>Why a storage VLAN 1. Isolates SMB, NFS and iSCSI from user and IoT traffic. 2. Lets you write precise firewall rules for storage flows. 3. Keeps broadcast and discovery noise away from the NAS.</p> <p>OPNsense interface and rules 1. Interfaces \u2192 Other Types then VLAN. Add tag 50 if not already present. 2. Interfaces \u2192 Assignments. Add VLAN50. Enable it. 3. Description VLAN50 Storage. IPv4 Static 10.10.50.1/24. Save and Apply. 4. Do not enable DHCP on VLAN 50. 5. Firewall \u2192 Aliases. Add host alias nas01 10.10.50.10. 6. Firewall \u2192 Rules then VLAN50.    1. Pass from VLAN10 net to VLAN50 net TCP 443 and TCP 22 for NAS management as needed.    2. Pass from VLAN20 net to nas01 TCP 445 for SMB.    3. Pass from VLAN30 net to nas01 TCP 2049 and TCP 111 for NFS.    4. Leave default block under these passes.</p> <p>NAS side 1. Plug the NAS into SFP+3. 2. Set NAS IP to 10.10.50.10/24. Gateway 10.10.50.1. DNS 10.10.10.30. 3. Disable SMB1. Prefer SMB3 or NFSv4 only. 4. Disable UPnP and DLNA unless required. 5. Optional. Use MTU 9000 only if every hop and endpoint supports it. Otherwise keep 1500. Checklist for MTU 9000 - NAS NIC MTU set to 9000 - CRS328 SFP+3 port MTU set to 9000 if exposed in SwOS, else leave default and keep 1500 everywhere - OPNsense VLAN50 interface MTU set to 9000 - Every endpoint or VM that talks to the NAS set to 9000 If any one item is not 9000, keep everything at 1500 to avoid path MTU issues.</p> <p>Validation for storage 1. From VLAN 20 map <code>\\\\nas01.home.arpa\\share</code> and confirm access. 2. From VLAN 30 mount an NFS export from nas01.home.arpa and confirm access. 3. From VLAN 40 IoT and VLAN 60 Guest confirm the NAS is not reachable.</p>"},{"location":"phases/1-onprem-bootstrap/#section-z-phase-1-validation-all-offline","title":"Section Z \u2013 Phase 1 validation all offline","text":"<p>Basic reachability 1. From the laptop on port 24 open https://10.10.10.1 and http://10.10.10.2. 2. From the laptop open http://10.10.10.30/admin.</p> <p>DHCP and DNS 1. On a test host in VLAN 20 confirm it gets a 10.10.20.x address and DNS 10.10.10.30. 2. From the same host run nslookup ctlpln01.home.arpa 10.10.10.30 and see 10.10.10.30. 3. Run nslookup google.com 10.10.10.1 and it should fail which proves the firewall resolver is blocked for clients.</p> <p>Isolation 1. From a VLAN 20 host try to open the switch or OPNsense GUI. It should fail. 2. From a VLAN 10 host both GUIs should work.</p> <p>Snapshots and backups 1. Download a fresh SwOS backup. 2. In OPNsense open System \u2192 Configuration then Backups and save a local copy.</p> <p>Now ready for Phase 2.</p>"}]}